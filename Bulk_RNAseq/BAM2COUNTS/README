# Bulk RNA-seq Analysis Pipeline

## Overview
This pipeline processes bulk RNA-seq data, starting from sorted BAM files to generate gene expression counts, perform quality control, and create normalized expression matrices.

## Table of Contents
1. [Prerequisites](#prerequisites)
2. [Installation](#installation)
3. [Directory Structure](#directory-structure)
4. [Usage](#usage)
5. [Output Files](#output-files)
6. [Quality Control](#quality-control)
7. [Troubleshooting](#troubleshooting)
8. [Contact](#contact)

## Prerequisites

### System Requirements
- SLURM workload manager
- 500GB RAM
- 16 CPU cores
- GPU partition access

### Required Software
```bash
# Modules
module load r
module load miniconda

# Conda environment
conda activate spatial

# R packages
- BiocManager
- GenomicAlignments
- GenomicFeatures
- Rsamtools
- rtracklayer
- DESeq2
```

### Input Requirements
1. Sorted BAM files (with index files .bai)
2. GENCODE v44 GTF annotation file

## Installation

1. Clone or download the pipeline script:
```bash
cd /N/project/akhaliq/
wget [script_url]/run_bam_count.sh
chmod +x run_bam_count.sh
```

2. Install required R packages:
```R
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install(c(
    "GenomicAlignments",
    "GenomicFeatures",
    "Rsamtools",
    "rtracklayer",
    "DESeq2"
))
```

## Directory Structure

### Input Directory Structure
```
/N/project/akhaliq/Ateeq_dwd/
├── Sample1
│   └── Sample1-RS.v2-RNA-XXXXXXXX
│       └── Sample1_T_sorted.bam
├── Sample2
│   └── Sample2-RS.v2-RNA-XXXXXXXX
│       └── Sample2_T_sorted.bam
└── ...
```

### Output Directory Structure
```
bulk_counts_[TIMESTAMP]/
├── raw_counts.csv           # Raw gene expression counts
├── raw_counts.rds          # R object of raw counts
├── normalized_counts.csv    # DESeq2 normalized counts
├── qc_metrics.csv          # Quality control metrics
├── qc_plots.pdf           # Quality control visualizations
└── bam_count.log          # Processing log
```

## Usage

### Basic Usage
```bash
sbatch run_bam_count.sh
```

### Monitor Job
```bash
# Check job status
squeue -u akhaliq

# Monitor log files
tail -f bam_count_[JOBID].out
tail -f bulk_counts_[TIMESTAMP]/bam_count.log
```

### Resource Configuration
Default SLURM settings:
```bash
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=16
#SBATCH --mem=500G
#SBATCH --time=40:00:00
```

## Output Files

### 1. Raw Counts (`raw_counts.csv`, `raw_counts.rds`)
- Gene-level read counts
- Rows: Genes
- Columns: Samples
- Format: CSV and R object

### 2. Normalized Counts (`normalized_counts.csv`)
- DESeq2 normalized expression values
- Accounts for library size differences
- Suitable for downstream analysis

### 3. QC Metrics (`qc_metrics.csv`)
- Total reads per sample
- Detected genes
- Detection rates
- Median counts
- Sample correlations

### 4. QC Plots (`qc_plots.pdf`)
- Library size distribution
- Gene detection rates
- Sample correlation heatmap
- MA plots

### 5. Log File (`bam_count.log`)
- Detailed processing steps
- Timestamps
- Error messages (if any)
- Processing statistics

## Quality Control

### Metrics Calculated
1. **Library Size**
   - Total reads per sample
   - Distribution across samples

2. **Gene Detection**
   - Number of detected genes
   - Detection rate percentages

3. **Sample Quality**
   - Sample correlations
   - Read distribution patterns
   - Coverage uniformity

### QC Thresholds
- Minimum library size: Variable
- Minimum detected genes: Sample dependent
- Correlation threshold: Study dependent

## Troubleshooting

### Common Issues

1. **Missing BAM Index**
   ```bash
   # Create BAM index
   samtools index sample_sorted.bam
   ```

2. **Resource Limits**
   - Adjust memory in SLURM script
   - Modify CPU allocation
   - Change time limit

3. **Package Installation**
   ```R
   # Manual package installation
   BiocManager::install("package_name")
   ```

### Error Messages

1. "Error: cannot allocate vector of size X"
   - Solution: Increase memory allocation

2. "BAM index not found"
   - Solution: Create index files

3. "Package not found"
   - Solution: Install missing packages

## Contact
- Author: akhaliq
- Email: akhaliq@iu.edu
- System: IU GPU cluster
